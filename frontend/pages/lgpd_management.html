<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o LGPD - Rota Hotspot Admin</title>
    <link rel="stylesheet" href="../css/admin_style.css">
    <link rel="stylesheet" href="../css/notifications.css">
    <!-- [NOVO] Adiciona a biblioteca para exporta√ß√£o para Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="dashboard-body">
    <aside class="sidebar">
        <nav class="sidebar-nav">
            <div class="nav-title">Principal</div>
            <a href="../admin_dashboard.html" class="nav-item">
                <span>üè†</span> Voltar ao Dashboard
            </a>
            <!-- [NOVO] Bot√£o para abrir o painel de logs -->
            <a href="#" id="openLogsBtn" class="nav-item">
                <span>üìú</span> Logs Detalhados
            </a>
        </nav>
    </aside>

    <main class="main-content">
        <header class="main-header">
            <div class="header-left">
                <h1 id="pageTitle">Gest√£o LGPD</h1>
            </div>
        </header>

        <section class="content-area">
            <div class="content-section">
                <div class="section-header">
                    <h4>Pedidos de Exclus√£o de Dados</h4>
                    <p class="input-hint">Lista de todos os pedidos de exclus√£o de dados feitos pelos utilizadores.</p>
                </div>
                <div class="table-container" style="margin-top: 20px;">
                    <table id="lgpdRequestsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>Email do Utilizador</th>
                                <th>Data do Pedido</th>
                                <th>Status</th>
                                <th>Data de Conclus√£o</th>
                                <th>Conclu√≠do Por</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lgpdRequestsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="content-section" style="margin-top: 40px;">
                <div class="section-header">
                    <h4>Pesquisar e Eliminar Utilizador do Hotspot</h4>
                    <p class="input-hint">Permite pesquisar por um utilizador e elimin√°-lo permanentemente.</p>
                </div>
                <form id="searchUserLgpdForm" class="filters-container" style="margin-top: 20px; display: flex; gap: 15px; align-items: flex-end;">
                    <div class="input-group">
                        <label for="lgpdSearchTerm">Termo de Pesquisa</label>
                        <input type="text" id="lgpdSearchTerm" placeholder="Nome, e-mail, telefone...">
                    </div>
                    <div class="input-group">
                        <label for="lgpdSearchType">Pesquisar por</label>
                        <select id="lgpdSearchType">
                            <option value="todos">Todos</option>
                            <option value="nome">Nome</option>
                            <option value="email">E-mail</option>
                            <option value="telefone">Telefone</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Pesquisar</button>
                    </div>
                </form>

                <div class="table-container" style="margin-top: 20px;">
                    <table id="lgpdUserSearchResultsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome Completo</th>
                                <th>E-mail</th>
                                <th>Telefone</th>
                                <th>MAC Address</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lgpdUserSearchResultsBody"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- [NOVO] Painel Lateral Deslizante para Logs -->
    <div id="logsSidebar" class="logs-sidebar">
        <div class="logs-sidebar-header">
            <h3>Logs de Atividade LGPD</h3>
            <button id="closeLogsBtn" class="modal-close-btn" style="position: static;">&times;</button>
        </div>
        <div class="logs-sidebar-content">
            <p class="input-hint" style="margin-bottom: 15px;">Hist√≥rico de a√ß√µes de conclus√£o e elimina√ß√£o.</p>
            
            <div class="header-actions" style="margin-bottom: 20px; justify-content: flex-start; flex-wrap: wrap;">
                <button id="exportLgpdCsvBtn" class="btn-secondary" style="font-size: 12px; padding: 6px 12px;">CSV</button>
                <button id="exportLgpdExcelBtn" class="btn-primary" style="font-size: 12px; padding: 6px 12px;">Excel</button>
            </div>

            <div class="table-container">
                <table id="lgpdLogsTable" class="data-table" style="font-size: 13px;">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>A√ß√£o</th>
                            <th>Detalhes</th>
                        </tr>
                    </thead>
                    <tbody id="lgpdLogsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="notification-container"></div>

    <script>
        // Script de seguran√ßa e API request embutido para autonomia da p√°gina
        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '../admin_login.html';
        }

        const apiRequest = async (endpoint, method = 'GET', body = null) => {
            const API_ADMIN_URL = `http://${window.location.hostname}:3000`;
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Cache-Control': 'no-cache'
                }
            };
            let url = `${API_ADMIN_URL}${endpoint}`;
            if (method === 'GET') {
                url += (url.includes('?') ? '&' : '?') + `_=${Date.now()}`;
            }
            if (body) {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }
            const response = await fetch(url, options);
            if (!response.ok) {
                if (response.status === 401) {
                    localStorage.removeItem('adminToken');
                    window.location.href = '../admin_login.html';
                }
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(errorData.message || `Erro HTTP ${response.status}`);
            }
            if (response.status === 204) return { success: true, data: null };
            // [CORRIGIDO] Retorna diretamente a resposta JSON do backend, sem a encapsular novamente.
            return await response.json();
        };
    </script>
    <script src="../js/notifications.js"></script>
    <script src="../js/lgpd_management.js"></script>
</body>
</html>