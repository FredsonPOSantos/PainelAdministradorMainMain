<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Roteador</title>
    
    <!-- CSS -->
    <!-- [UNIFICADO] Usa apenas a folha de estilos partilhada para um visual consistente. -->
    <link rel="stylesheet" href="/css/monitoring_styles.css">
    
    <!-- Biblioteca de Gráficos ApexCharts.js -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- [NOVO] Biblioteca para exportação Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- [NOVO] Bibliotecas para exportação PDF e PNG -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <!-- [MODIFICADO] Cabeçalho com métricas em tempo real -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-info">
                    <h1 id="routerNameTitle">A carregar...</h1>
                    <p id="routerIpDisplay">IP: -</p>
                </div>
                <div class="live-stats-header">
                    <div class="live-stat">
                        <span class="live-stat-label"><i class="fas fa-microchip"></i> CPU</span>
                        <span class="live-stat-value" id="liveCpu">-</span>
                    </div>
                    <div class="live-stat">
                        <span class="live-stat-label"><i class="fas fa-memory"></i> Memória</span>
                        <span class="live-stat-value" id="liveMemory">-</span>
                    </div>
                    <div class="live-stat">
                        <span class="live-stat-label"><i class="fas fa-users"></i> Clientes Hotspot</span>
                        <span class="live-stat-value" id="liveClients">-</span>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="live-update-toggle">
                        <label for="liveUpdateToggle" class="toggle-label">Live Update</label>
                        <label class="switch">
                            <input type="checkbox" id="liveUpdateToggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <button class="btn-back" onclick="window.history.back()">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                </div>
            </div>
        </header>

        <!-- [NOVO] Secção de Resumo com Gráficos -->
        <h2 class="section-title">Resumo</h2>
        <!-- [MODIFICADO] Adiciona a classe 'summary-grid' para aplicar estilos transparentes. -->
        <div class="metrics-grid summary-grid">
            <!-- Card de CPU com Gráfico Radial -->
            <div class="metric-card" data-metric="cpu">
                <div class="card-header">
                    <div class="card-icon cpu-icon"><i class="fas fa-microchip"></i></div>
                    <h3>CPU</h3>
                    <div class="card-actions">
                        <!-- [CORRIGIDO] O ícone de engrenagem agora abre o modal principal, como os outros botões de análise. -->
                        <i class="fas fa-cog settings-icon" onclick="expandMetric('cpu')"></i>
                    </div>
                </div>
                <div id="cpu-chart-container" class="card-chart-container"></div>
                <div class="card-stats-summary">
                    <div><span>MÍN</span><strong id="cpu-min">-</strong></div>
                    <div><span>MÉD</span><strong id="cpu-avg">-</strong></div>
                    <div><span>MÁX</span><strong id="cpu-max">-</strong></div>
                </div>
            </div>

            <!-- Card de Memória com Gráfico Radial -->
            <div class="metric-card" data-metric="memory">
                <div class="card-header">
                    <div class="card-icon memory-icon"><i class="fas fa-memory"></i></div>
                    <h3>Memória</h3>
                    <div class="card-actions">
                        <!-- [CORRIGIDO] O ícone de engrenagem agora abre o modal principal, como os outros botões de análise. -->
                        <i class="fas fa-cog settings-icon" onclick="expandMetric('memory')"></i>
                    </div>
                </div>
                <div id="memory-chart-container" class="card-chart-container"></div>
                <div class="card-stats-summary">
                    <div><span>MÍN</span><strong id="memory-min">-</strong></div>
                    <div><span>MÉD</span><strong id="memory-avg">-</strong></div>
                    <div><span>MÁX</span><strong id="memory-max">-</strong></div>
                </div>
            </div>

            <!-- Card de Distribuição de Tráfego -->
            <div class="metric-card" data-metric="traffic-distribution">
                <div class="card-header">
                    <div class="card-icon interface-icon"><i class="fas fa-network-wired"></i></div>
                    <h3>Distribuição de Tráfego</h3>
                </div>
                <div id="traffic-distribution-chart-container" class="card-chart-container"></div>
            </div>
        </div>

        <!-- Cards de Métricas - Sistema -->
        <h2 class="section-title">Sistema</h2>
        <div class="metrics-grid">
            <!-- O card de Uptime permanece aqui -->
            <div class="metric-card" data-metric="uptime">
                <div class="card-header">
                    <div class="card-icon uptime-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h3>Uptime</h3>
                </div>
                <div class="card-stats">
                    <div class="stat-row main-stat">
                        <span class="stat-label">Status Atual:</span>
                        <span id="uptime-status" class="stat-value">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Quedas (24h):</span>
                        <span id="uptime-offline-events" class="stat-value">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Online (7d):</span>
                        <span class="stat-value" id="uptime-7d">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Online (30d):</span>
                        <span class="stat-value" id="uptime-30d">-</span>
                    </div>
                </div>
                <div class="card-footer">
                    <span class="footer-text">Disponibilidade do Roteador</span>
                </div>
            </div>
        </div>

        <!-- Cards de Métricas - Clientes -->
        <h2 class="section-title">Clientes Conectados</h2>
        <div class="metrics-grid">
            <!-- Clientes -->
            <div class="metric-card" data-metric="wifi-clients">
                <div class="card-header">
                    <div class="card-icon wifi-icon">
                        <i class="fas fa-wifi"></i>
                    </div>
                    <h3>Clientes Wi-Fi</h3>
                </div>
                <div class="card-stats">
                    <div class="stat-row main-stat">
                        <span class="stat-label">Conectados:</span>
                        <span class="stat-value" id="wifi-clients-count">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Únicos (1h):</span>
                        <span class="stat-value" id="wifi-clients-1h">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Únicos (7d):</span>
                        <span class="stat-value" id="wifi-clients-7d">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Únicos (30d):</span>
                        <span class="stat-value" id="wifi-clients-30d">-</span>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn-expand" onclick="expandMetric('wifi-clients')">
                        <i class="fas fa-chart-pie"></i> Análise
                    </button>
                </div>
            </div>

            <div class="metric-card" data-metric="dhcp-clients">
                <div class="card-header">
                    <div class="card-icon dhcp-icon">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <h3>Clientes DHCP</h3>
                </div>
                <div class="card-stats">
                    <div class="stat-row main-stat">
                        <span class="stat-label">Conectados:</span>
                        <span class="stat-value" id="dhcp-clients-count">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label"></span>
                        <span class="stat-value" id="dhcp-clients-distribution"></span>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn-expand" onclick="expandMetric('dhcp-clients')">
                        <i class="fas fa-chart-pie"></i> Análise
                    </button>
                </div>
            </div>

            <div class="metric-card" data-metric="hotspot-clients">
                <div class="card-header">
                    <div class="card-icon hotspot-icon">
                        <i class="fas fa-wifi-strong"></i>
                    </div>
                    <h3>Hotspot Ativos</h3>
                </div>
                <div class="card-stats">
                    <div class="stat-row main-stat">
                        <span class="stat-label">Conectados:</span>
                        <span class="stat-value" id="hotspot-clients-count">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Únicos (1h):</span>
                        <span class="stat-value" id="hotspot-clients-1h">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Únicos (24h):</span>
                        <span class="stat-value" id="hotspot-clients-24h">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Únicos (7d):</span>
                        <span class="stat-value" id="hotspot-clients-7d">-</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Únicos (30d):</span>
                        <span class="stat-value" id="hotspot-clients-30d">-</span>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn-expand" onclick="expandMetric('hotspot-clients')">
                        <i class="fas fa-chart-bar"></i> Análise
                    </button>
                </div>
            </div>
        </div>

        <!-- Cards de Métricas - Interfaces -->
        <h2 class="section-title">Interfaces de Rede</h2>
        <div id="interfaces-container" class="metrics-grid"></div>
    </div>

    <!-- Modal para Gráfico Expandido -->
    <div id="expandedModal" class="expanded-modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Gráfico</h2>
                <button class="btn-close" onclick="closeExpandedChart()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Filtros do Modal -->
            <div class="modal-filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <span class="filter-label">Período:</span>
                        <button class="filter-btn active" data-range="1h" onclick="updateExpandedChart('1h')">1h</button>
                        <button class="filter-btn" data-range="6h" onclick="updateExpandedChart('6h')">6h</button>
                        <button class="filter-btn" data-range="24h" onclick="updateExpandedChart('24h')">24h</button>
                        <button class="filter-btn" data-range="7d" onclick="updateExpandedChart('7d')">7d</button>
                        <button class="filter-btn" data-range="30d" onclick="updateExpandedChart('30d')">30d</button>
                    </div>
                </div>
                
                <div class="filter-row" id="chartTypeFilters" style="display: none;">
                    <div class="filter-group">
                        <span class="filter-label">Dados:</span>
                        <button class="filter-btn active" data-type="both" onclick="updateChartType('both')">RX + TX</button>
                        <button class="filter-btn" data-type="rx" onclick="updateChartType('rx')">RX</button>
                        <button class="filter-btn" data-type="tx" onclick="updateChartType('tx')">TX</button>
                    </div>
                </div>

                <div class="filter-row" id="chartVisualizationFilters" style="display: none;">
                    <div class="filter-group">
                        <span class="filter-label">Visualização:</span>
                        <button class="filter-btn active" data-visualization="area" onclick="updateChartVisualization('area')">
                            <i class="fas fa-chart-area"></i> Área
                        </button>
                        <button class="filter-btn" data-visualization="bar" onclick="updateChartVisualization('bar')">
                            <i class="fas fa-chart-bar"></i> Barras
                        </button>
                        <button class="filter-btn" data-visualization="line" onclick="updateChartVisualization('line')">
                            <i class="fas fa-chart-line"></i> Linha
                        </button>
                    </div>
                </div>
            </div>

            <!-- [NOVO] Loader para o gráfico -->
            <div id="chartLoader" class="chart-loader hidden">
                <div class="spinner"></div>
                <p>A carregar dados...</p>
            </div>

            <div id="expandedChart" class="expanded-chart"></div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- [CORRIGIDO] Carrega o ficheiro de utilitários em vez do script do dashboard principal -->
    <script src="/js/utils.js" defer></script>
    <script src="/js/router_dashboard.js" defer></script>
    <script>
        // [NOVO] Funções globais para controlar o loader do gráfico
        // Chame window.showChartLoader() antes de iniciar o fetch dos dados
        window.showChartLoader = function() {
            const loader = document.getElementById('chartLoader');
            if (loader) loader.classList.remove('hidden');
        };
        
        // Chame window.hideChartLoader() no finally do seu fetch
        window.hideChartLoader = function() {
            const loader = document.getElementById('chartLoader');
            if (loader) loader.classList.add('hidden');
        };
    </script>
</body>
</html>
