<!-- Ficheiro: pages/admin_settings.html -->
<!-- [VERS√ÉO 13.5.3 - GEST√ÉO BATCH + CORRE√á√ÉO DE LABELS] -->

<!-- [NOVO] Adiciona os recursos do editor de texto Trix -->
<link rel="stylesheet" type="text/css" href="https://unpkg.com/trix@2.0.0/dist/trix.css">
<script type="text/javascript" src="https://unpkg.com/trix@2.0.0/dist/trix.umd.min.js" defer></script>

<div class="page-header">
    <h3>Configura√ß√µes do Sistema</h3>
</div>

<!-- Navega√ß√£o em Abas -->
<nav class="tab-nav">
    <button class="tab-link active admin-only" data-tab="tab-empresa">Meus Servi√ßos</button>
    <button class="tab-link admin-only" data-tab="tab-hotspot">Portal Hotspot</button>
    <button class="tab-link admin-only" data-tab="tab-aparencia">Apar√™ncia Geral</button>
    <!-- [ATUALIZADO V13.5.2] Removido master-only daqui para o JS controlar (permite DPO) -->
    <button class="tab-link admin-only" data-tab="tab-permissoes">Fun√ß√µes e Permiss√µes</button>
    <button class="tab-link admin-only" data-tab="tab-politicas">Pol√≠ticas de Seguran√ßa</button> <!-- [NOVO] Aba de Pol√≠ticas -->
    <button class="tab-link admin-only" data-tab="tab-logs">Logs e Atividades do Sistema</button>
    <button class="tab-link admin-only master-only" data-tab="tab-arquivos">Gest√£o de Arquivos Locais</button> <!-- [NOVO] -->
    <button class="tab-link admin-only" data-tab="tab-lgpd">Gest√£o de Dados</button>
</nav>

<!-- Conte√∫do das Abas -->
<div class="tab-content-container">

    <!-- Aba 2: Geral (Fase 2.3) -->
    <div id="tab-empresa" class="tab-content active admin-only">
        <div class="content-section">
            <div class="section-header">
                <h4>Configura√ß√µes do Servidor de E-mail (SMTP)</h4>
            </div>
            <form id="smtpSettingsForm">
                <div class="input-group">
                    <label for="emailHost">Host do Servidor (ex: smtps.uhserver.com)</label>
                    <input type="text" id="emailHost" name="email_host">
                </div>
                <div class="input-group">
                    <label for="emailPort">Porta (ex: 465)</label>
                    <input type="number" id="emailPort" name="email_port">
                </div>
                <div class="input-group">
                    <label for="emailUser">Utilizador (e-mail)</label>
                    <input type="email" id="emailUser" name="email_user">
                </div>
                <div class="input-group">
                    <label for="emailPass">Senha do E-mail</label>
                    <input type="password" id="emailPass" name="email_pass" placeholder="Deixe em branco para n√£o alterar">
                </div>
                <div class="input-group">
                    <label for="emailFrom">E-mail do Remetente (ex: "Nome Empresa &lt;email@dominio.com&gt;")</label>
                    <input type="text" id="emailFrom" name="email_from">
                </div>
                <div class="input-group checkbox-group" style="flex-direction: row; align-items: center;">
                    <input type="checkbox" id="emailSecure" name="email_secure" style="width: auto; margin-right: 10px;">
                    <label for="emailSecure" style="margin-bottom: 0;">Usar Conex√£o Segura (SSL/TLS)</label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Salvar Configura√ß√µes de E-mail</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Aba Apar√™ncia (REESTRUTURADA) -->
    <div id="tab-aparencia" class="tab-content admin-only">
        <style>
            .settings-grid-container {
                display: flex;
                gap: 40px;
                flex-wrap: wrap;
            }
            .settings-column {
                flex: 1;
                min-width: 300px; /* Garante que a coluna n√£o fique muito estreita */
            }
            .column-title {
                font-weight: bold;
                margin-bottom: 15px;
                border-bottom: 1px solid var(--border-color, #e76005);
                padding-bottom: 10px;
                font-size: 1.094em;
                text-align: center;
            }
            /* [NOVO] Layout para os seletores de cor */
            .color-picker-grid {
                display: grid;
                gap: 10px; /* [CORRIGIDO] Espa√ßamento uniforme e reduzido */
                align-items: end; /* [CORRIGIDO] Alinha os itens na base para um alinhamento perfeito dos inputs */
            }
            /* [NOVO] Garante que os input-groups dentro da grelha se comportem corretamente */
            .color-picker-grid .input-group {
                display: flex;
                flex-direction: column; /* Empilha label e input verticalmente */
            }
            .color-picker-grid label {
                margin-bottom: 8px; /* [CORRIGIDO] Espa√ßamento vertical reduzido */
            }
        </style>
        <form id="unifiedAppearanceForm" enctype="multipart/form-data">
            
            <div class="content-section appearance-section"> <!-- Classe adicionada -->
                <div class="section-header">
                    <h4>Apar√™ncia Geral do Painel</h4>
                </div>

                <div class="settings-grid-container">
                    <!-- Coluna 0: Nome e Logo da Empresa -->
                    <div class="settings-column">
                        <p class="column-title">Identidade da Empresa</p>
                        <div class="input-group">
                            <label for="companyName">Nome da Empresa</label>
                            <input type="text" id="companyName" placeholder="O nome que aparece no painel">
                        </div>
                        <div class="input-group">
                            <label for="adminSessionTimeout">Tempo de Inatividade (minutos)</label>
                            <input type="number" id="adminSessionTimeout" min="1" max="1440" placeholder="30">
                            <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                                Tempo m√°ximo sem uso antes de bloquear a sess√£o automaticamente.
                            </small>
                        </div>
                        <div class="input-group">
                            <label for="logoUpload">Log√≥tipo do Painel (.png, .jpg, .svg)</label>
                            <input type="file" id="logoUpload" name="companyLogo" accept="image/png, image/jpeg, image/svg+xml">
                            <div class="logo-preview-container" style="margin-top: 15px; text-align: center; display: inline-flex;">
                                <img id="currentLogoPreview" src="#" alt="Logo Atual" style="display: none; max-height: 150px; background-color: #fff; border-radius: 10px; padding: 5px; border: 1px solid #ddd;">
                            </div>
                        </div>
                    </div>
                    <!-- Coluna 1 -->
                    <div class="settings-column">
                        <p class="column-title">Cores Principais</p>
                        <div class="input-group">
                            <label for="primaryColor">Cor Prim√°ria (destaques)</label>
                            <input type="color" id="primaryColor" class="color-picker">
                        </div>
                        <div class="input-group">
                            <label for="backgroundColor">Cor do Fundo do Painel</label>
                            <input type="color" id="backgroundColor" class="color-picker">
                        </div>
                        <div class="input-group">
                            <label for="sidebarColor">Cor do Menu Lateral</label>
                            <input type="color" id="sidebarColor" class="color-picker">
                        </div>
                        <div class="input-group">
                            <label for="fontColor">Cor da Fonte do Painel</label>
                            <input type="color" id="fontColor" class="color-picker">
                        </div>
                    </div>
                    <!-- Coluna 2 -->
                    <div class="settings-column">
                        <p class="column-title">Fontes e janelas</p>
                        <div class="input-group">
                            <label for="fontFamily">Fonte Principal</label>
                            <select id="fontFamily">
                                <option value="'Inter', sans-serif" style="font-family: 'Inter', sans-serif;">Inter (Padr√£o)</option>
                                <option value="'Arial', sans-serif" style="font-family: 'Arial', sans-serif;">Arial</option>
                                <option value="'Verdana', sans-serif" style="font-family: 'Verdana', sans-serif;">Verdana</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="fontSize">Tamanho da Fonte (px)</label>
                            <input type="number" id="fontSize" min="10" max="24">
                        </div>
                        <div class="input-group">
                            <label for="modalBackgroundColor">Fundo das Janelas</label>
                            <input type="color" id="modalBackgroundColor" class="color-picker">
                        </div>
                        <div class="input-group">
                            <label for="modalFontColor">Fonte das janelas</label>
                            <input type="color" id="modalFontColor" class="color-picker">
                        </div>
                        <div class="input-group">
                            <label for="modalBorderColor">Borda das Janelas</label>
                            <input type="color" id="modalBorderColor" class="color-picker">
                        </div>
                    </div>
                    <!-- [NOVO] Coluna 3: Navega√ß√£o e Tipografia -->
                    <div class="settings-column">
                        <p class="column-title">Navega√ß√£o e Tipografia</p>
                        <div class="input-group">
                            <label for="navTitleColor">Cor T√≠tulo Menu</label>
                            <input type="color" id="navTitleColor" class="color-picker">
                        </div>
                        <div class="input-group">
                            <label for="labelColor">Cor Labels (Formul√°rios)</label>
                            <input type="color" id="labelColor" class="color-picker">
                        </div>
                        <div class="input-group">
                            <label for="placeholderColor">Cor Placeholders (Inputs)</label>
                            <input type="color" id="placeholderColor" class="color-picker">
                        </div>
                        <div class="input-group">
                            <label for="tabLinkColor">Cor Abas Navega√ß√£o</label>
                            <input type="color" id="tabLinkColor" class="color-picker">
                        </div>
                        <div class="input-group">
                            <label for="tabLinkActiveColor">Cor Aba Ativa</label>
                            <input type="color" id="tabLinkActiveColor" class="color-picker">
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-section login-appearance-section"> <!-- Classe adicionada -->
                <div class="section-header">
                    <h4>Apar√™ncia da P√°gina de Login</h4>
                </div>
                
                <div class="settings-grid-container">
                    <!-- Coluna 1: Cores e Fundo -->
                    <div class="settings-column">
                        <p class="column-title">Fundo e Cores</p>
                        <div class="input-group">
                            <label for="backgroundUpload">Imagem de Fundo</label>
                            <input type="file" id="backgroundUpload" name="backgroundImage" accept="image/png, image/jpeg">
                            <div class="image-preview-container" style="margin-top: 10px;">
                                <img id="currentBackgroundPreview" src="#" alt="Imagem de Fundo Atual" style="display: none; max-width: 100%; max-height: 100px; object-fit: cover; border: 1px solid #ccc; border-radius: 4px;">
                                <button type="button" id="removeBackground" class="btn-remove-img" style="display: none;" title="Remover Imagem">&times;</button>
                            </div>
                        </div>
                        <div class="color-picker-grid" style="margin-top: 20px;">
                            <div class="input-group">
                                <label for="loginBackgroundColor">Fundo (Cor)</label>
                                <input type="color" id="loginBackgroundColor" class="color-picker">
                            </div>
                            <div class="input-group">
                                <label for="loginFormBackgroundColor">Formul√°rio</label>
                                <input type="color" id="loginFormBackgroundColor" class="color-picker">
                            </div>
                        </div>
                    </div>

                    <!-- Coluna 2: Logo -->
                    <div class="settings-column">
                        <p class="column-title">Logo</p>
                        <div class="input-group">
                            <label for="loginLogoUpload">Logo da P√°gina de Login</label>
                            <input type="file" id="loginLogoUpload" name="loginLogo" accept="image/png, image/jpeg, image/svg+xml">
                            <div class="image-preview-container" style="margin-top: 10px;">
                                <img id="currentLoginLogoPreview" src="#" alt="Logo de Login Atual" style="display: none; max-width: 180px; max-height: 60px; background-color: #fff; border-radius: 4px; padding: 5px; border: 1px solid #ccc;">
                                <button type="button" id="removeLoginLogo" class="btn-remove-img" style="display: none;" title="Remover Logo">&times;</button>
                            </div>
                        </div>
                        <div class="color-picker-grid" style="margin-top: 20px;">
                            <div class="input-group">
                                <label for="loginFontColor">Fonte</label>
                                <input type="color" id="loginFontColor" class="color-picker">
                            </div>
                            <div class="input-group">
                                <label for="loginButtonColor">Bot√£o</label>
                                <input type="color" id="loginButtonColor" class="color-picker">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- A√ß√µes do Formul√°rio -->
            <div class="form-actions" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                <button type="submit" id="saveAppearanceBtn" class="btn-primary">Aplicar Todas as Altera√ß√µes de Apar√™ncia</button>
                <button type="button" id="resetAppearanceBtn" class="btn-secondary">Repor Predefini√ß√µes</button>
            </div>
        </form>
    </div>
    
    <!-- Aba 3: Portal Hotspot (Fase 2.4) -->
    <div id="tab-hotspot" class="tab-content admin-only master-only">
        <div class="content-section">
            <div class="section-header">
                <h4>Portal Hotspot</h4>
            </div>
            <form id="hotspotSettingsForm">
                <div class="input-group">
                    <!-- [CORRIGIDO] Adicionado for="sessionTimeoutMinutes" -->
                    <label for="sessionTimeoutMinutes">Tempo de Sess√£o (minutos)</label>
                    <input type="number" id="sessionTimeoutMinutes" placeholder="Ex: 60" min="1">
                    <p class="input-hint">Tempo que o utilizador final fica autenticado antes de precisar logar novamente.</p>
                </div>
                
                <div class="input-group">
                    <!-- [CORRIGIDO] Adicionado for="domainWhitelist" -->
                    <label for="domainWhitelist">Whitelist de Dom√≠nios (um por linha)</label>
                    <textarea id="domainWhitelist" rows="5" placeholder="Ex:\ngoogle.com\nfacebook.com\nwhatsapp.net"></textarea>
                    <p class="input-hint">Dom√≠nios que o utilizador pode acessarr *antes* de se autenticar no hotspot.</p>
                </div>


                <div class="form-actions">
                    <button type="submit" class="btn-primary">Aplicar Configura√ß√µes do Hotspot</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Aba 4: Fun√ß√µes e Permiss√µes (Fase 3.1 - V13.5.3) -->
    <div id="tab-permissoes" class="tab-content admin-only">
        <div class="content-section">
             <div class="section-header">
                <h4>Fun√ß√µes e Permiss√µes</h4>
            </div>
            <div class="permissions-matrix" style="margin-top: 20px;">

                
                <p id="permHelpTextMaster" class="input-hint" style="display: none; margin-bottom: 15px;">
                    Selecione as permiss√µes para cada fun√ß√£o. As altera√ß√µes s√≥ ser√£o aplicadas ap√≥s clicar em "Salvar Altera√ß√µes".
                </p>
                <p id="permHelpTextDPO" class="input-hint" style="display: none; margin-bottom: 15px;">
                    Modo de auditoria (Leitura). Apenas o 'master' pode editar as permiss√µes.
                </p>

                <!-- O cont√™iner da nova grade de permiss√µes -->
                <div id="permissionsGridContainer"></div>
                
                <!-- Bot√£o Salvar (V13.5.3) -->
                <div id="permSaveChangesContainer" class="form-actions" style="display: none; margin-top: 25px;">
                    <button type="button" id="permSaveChangesBtn" class="btn-primary">Salvar Altera√ß√µes</button>
                    <span id="permSaveStatus" style="margin-left: 15px; font-weight: 500;"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Aba 5: Logs de Atividade (Fase 3.2) -->
    <div id="tab-logs" class="tab-content admin-only"> 
        <div class="content-section">
            <div class="section-header">
                <h4>Logs de Atividade do Painel</h4>
                
                <p class="input-hint">Exibe as √∫ltimas 200 a√ß√µes registadas no sistema.</p>
                <div class="header-actions">
                    <button id="exportCsvBtn" class="btn-secondary">Exportar para CSV</button>
                    <button id="exportExcelBtn" class="btn-primary">Exportar para Excel</button>
                </div>
            </div>

            <div class="filters-container" style="margin-top: 20px; display: flex; gap: 15px; align-items: flex-end;">
                <div class="input-group">
                    <label for="logKeyword">Palavra-chave</label>
                    <input type="text" id="logKeyword" placeholder="Ex: login, user_update, ...">
                </div>
                <div class="input-group">
                    <label for="logStartDate">Data In√≠cio</label>
                    <input type="date" id="logStartDate">
                </div>
                <div class="input-group">
                    <label for="logEndDate">Data Fim</label>
                    <input type="date" id="logEndDate">
                </div>
                <div class="form-actions">
                    <button id="filterLogsBtn" class="btn-primary">Filtrar</button>
                    <button id="clearFiltersBtn" class="btn-secondary">Limpar</button>
                </div>
            </div>
            
            <!-- TODO: Adicionar filtros de pesquisa no futuro (data, utilizador, a√ß√£o) -->

            <div class="table-container" style="margin-top: 20px;">
                <table id="auditLogsTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Utilizador</th>
                            <th>IP</th>
                            <th>A√ß√£o</th>
                            <th>Status</th>
                            <th>Descri√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="auditLogsTableBody">
                        <!-- As linhas de log ser√£o inseridas aqui pelo JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- [NOVO] Aba 8: Gest√£o de Arquivos (Media Manager) -->
    <div id="tab-arquivos" class="tab-content admin-only master-only">
        <div class="content-section">
            <div class="section-header">
                <h4>Gest√£o de Arquivos (Imagens)</h4>
                <p class="input-hint">Visualize e elimine permanentemente imagens do servidor. Cuidado: Esta a√ß√£o √© irrevers√≠vel.</p>
            </div>
            
            <div class="filters-container" style="margin-top: 20px; justify-content: flex-start;">
                <div class="input-group">
                    <label for="mediaTypeSelect">Tipo de Arquivo</label>
                    <select id="mediaTypeSelect">
                        <option value="banners">Banners</option>
                        <option value="backgrounds">Planos de Fundo (Backgrounds)</option>
                        <option value="logos">Log√≥tipos</option>
                        <!-- [NOVO] Op√ß√£o para anexos de tickets -->
                        <option value="ticket_attachments">Anexos de Tickets (Auditoria)</option>
                        <option value="hotspot_backgrounds">Hotspot Backgrounds</option>
                        <option value="hotspot_logos">Hotspot Logos</option>
    </select>                    </select>
                </div>
                <div class="form-actions" style="margin-bottom: 20px; gap: 10px;">
                    <button id="refreshMediaBtn" class="btn-secondary">Atualizar Lista</button>
                    <!-- [NOVO] Bot√£o de Arquivar (vis√≠vel apenas para tickets) -->
                    <button id="archiveMediaBtn" class="btn-primary hidden" style="background-color: #d69e2e; color: #fff;">üì¶ Arquivar e Limpar</button>
                </div>
            </div>

            <div id="mediaGallery" class="media-grid">
                <!-- As imagens ser√£o carregadas aqui via JS -->
                <p style="text-align:center; width:100%; color: var(--text-secondary);">Selecione um tipo para carregar.</p>
            </div>
        </div>
    </div>

        <!-- Aba 6: Gest√£o LGPD (Fase 3.3) -->
        <div id="tab-lgpd" class="tab-content admin-only"> 
            <div class="content-section">
                 <div class="section-header">
                    <h4>Gest√£o de Pedidos de Exclus√£o de Dados (LGPD)</h4>
                </div>
                <p style="margin-top: 10px;">A gest√£o de dados foi movida para uma p√°gina dedicada por motivos de seguran√ßa.</p>
                <button id="goToLgpdPageBtn" class="btn-primary" style="margin-top: 20px;">Acessar √† Gest√£o de Dados</button>
            </div>
        </div>
</div>
        </div>
    </div>

    <!-- [ATUALIZADO] Aba 7: Pol√≠ticas - Agora com bot√µes para abrir o modal -->
    <div id="tab-politicas" class="tab-content admin-only" style="text-align: center;">
        <div class="content-section">
            <div class="section-header">
                <h4>Gest√£o de Pol√≠ticas</h4>
            </div>
            <p class="input-hint" style="margin-bottom: 25px;">Clique para visualizar ou editar o conte√∫do das pol√≠ticas exibidas no portal do hotspot.</p>
            <div class="form-actions" style="justify-content: center; border-top: none; padding-top: 0;">
                <button id="viewTermsBtn" class="btn-primary">Termos e Condi√ß√µes</button>
                <button id="viewMarketingPolicyBtn" class="btn-secondary">Pol√≠tica de Sorteios</button>
            </div>
        </div>
    </div>


    <!-- [NOVO] Modal para Visualizar/Editar Pol√≠ticas -->
    <div id="policyModal" class="modal-overlay hidden">
        <div class="modal-content large">
            <button class="modal-close-btn">&times;</button>
            <h3 id="policyModalTitle"></h3>
            <div id="policyViewer" class="policy-viewer">
                <!-- O conte√∫do ser√° inserido aqui -->
            </div>
            <div id="policyEditor" class="hidden">
                <form id="policyEditForm">
                    <input type="hidden" id="policyTypeField">
                    <input id="policyContentField" type="hidden" name="content">
                    <trix-editor input="policyContentField" class="trix-content"></trix-editor>
                </form>
            </div>
            <div id="policyModalActions" class="modal-actions">
                <!-- Bot√µes de a√ß√£o (Editar, Salvar, Cancelar) ser√£o inseridos aqui -->
            </div>
        </div>
    </div>

    <!-- [NOVO] Modal para Criar/Editar Perfis -->
    <div id="roleModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3 id="roleModalTitle">Novo Perfil</h3>
            <form id="roleForm">
                <input type="hidden" id="roleSlugOriginal"> <!-- Para edi√ß√£o -->
                <div class="input-group">
                    <label for="roleName">Nome do Perfil</label>
                    <input type="text" id="roleName" required placeholder="Ex: Financeiro">
                </div>
                <div class="input-group" id="roleSlugGroup">
                    <label for="roleSlug">Identificador (Slug)</label>
                    <input type="text" id="roleSlug" placeholder="Ex: financeiro (gerado automaticamente)">
                    <p class="input-hint">Usado internamente pelo sistema. Apenas letras min√∫sculas e underscores.</p>
                </div>
                <div class="input-group">
                    <label for="roleDescription">Descri√ß√£o</label>
                    <textarea id="roleDescription" rows="3" placeholder="Breve descri√ß√£o das responsabilidades deste perfil."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary modal-close-btn-action">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

</div>
