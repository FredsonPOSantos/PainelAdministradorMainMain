<!-- Ficheiro: pages/admin_settings.html -->
<!-- [VERSÃO 13.5.3 - GESTÃO BATCH + CORREÇÃO DE LABELS] -->

<div class="page-header">
    <h3>Configurações do Sistema</h3>
</div>

<!-- Navegação em Abas -->
<nav class="tab-nav">
    <button class="tab-link active" data-tab="tab-perfil">Meu Perfil</button>
    <button class="tab-link admin-only" data-tab="tab-empresa">Empresa</button>
    <button class="tab-link admin-only" data-tab="tab-hotspot">Portal Hotspot</button>
    <button class="tab-link admin-only" data-tab="tab-aparencia">Aparência</button>
    <!-- [ATUALIZADO V13.5.2] Removido master-only daqui para o JS controlar (permite DPO) -->
    <button class="tab-link admin-only" data-tab="tab-permissoes">Funções e Permissões</button>
    <button class="tab-link admin-only" data-tab="tab-logs">Logs de Atividade</button>
    <button class="tab-link admin-only" data-tab="tab-lgpd">Gestão LGPD</button>
</nav>

<!-- Conteúdo das Abas -->
<div class="tab-content-container">

    <!-- Aba 1: Meu Perfil (Fase 2.2 - Concluída) -->
    <div id="tab-perfil" class="tab-content active">
        <div class="content-section">
            <div class="section-header">
                <h4>Alterar Minha Senha (Voluntariamente)</h4>
            </div>
            <form id="changeOwnPasswordForm">
                <div class="input-group">
                    <!-- [CORRIGIDO] Adicionado 'for' -->
                    <label for="currentPassword">Senha Atual</label>
                    <input type="password" id="currentPassword" required>
                </div>
                <div class="input-group">
                    <!-- [CORRIGIDO] Adicionado 'for' -->
                    <label for="newVoluntaryPassword">Nova Senha (mín. 6 caracteres)</label>
                    <input type="password" id="newVoluntaryPassword" required minlength="6">
                </div>
                <div class="input-group">
                    <!-- [CORRIGIDO] Adicionado 'for' -->
                    <label for="confirmNewVoluntaryPassword">Confirmar Nova Senha</label>
                    <input type="password" id="confirmNewVoluntaryPassword" required minlength="6">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">Alterar Senha</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Aba 2: Geral (Fase 2.3) -->
    <div id="tab-empresa" class="tab-content admin-only master-only"></div>


    <!-- Aba Aparência (REESTRUTURADA) -->
    <div id="tab-aparencia" class="tab-content admin-only">
        <style>
            .settings-grid-container {
                display: flex;
                gap: 40px;
                flex-wrap: wrap;
            }
            .settings-column {
                flex: 1;
                min-width: 300px; /* Garante que a coluna não fique muito estreita */
            }
            .column-title {
                font-weight: bold;
                margin-bottom: 15px;
                border-bottom: 1px solid var(--border-color, #e76005);
                padding-bottom: 10px;
                font-size: 1.1em;
            }
            .color-picker-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
            }
        </style>
        <form id="unifiedAppearanceForm" enctype="multipart/form-data">
            
            <div class="content-section">
                <div class="section-header">
                    <h4>Aparência Geral do Painel</h4>
                </div>

                <div class="settings-grid-container">
                    <!-- Coluna 0: Nome e Logo da Empresa -->
                    <div class="settings-column">
                        <p class="column-title">Identidade da Empresa</p>
                        <div class="input-group">
                            <label for="companyName">Nome da Empresa</label>
                            <input type="text" id="companyName" placeholder="O nome que aparece no painel">
                        </div>
                        <div class="input-group">
                            <label for="logoUpload">Logótipo do Painel (.png, .jpg, .svg)</label>
                            <input type="file" id="logoUpload" name="companyLogo" accept="image/png, image/jpeg, image/svg+xml">
                            <div class="logo-preview-container" style="margin-top: 10px;">
                                <img id="currentLogoPreview" src="#" alt="Logo Atual" style="display: none; max-height: 50px; background-color: #fff; border-radius: 4px; padding: 5px;">
                            </div>
                        </div>
                    </div>
                    <!-- Coluna 1 -->
                    <div class="settings-column">
                        <p class="column-title">Cores Principais</p>
                        <div class="input-group">
                            <label for="primaryColor">Cor Primária (destaques)</label>
                            <input type="color" id="primaryColor" class="color-picker">
                        </div>
                        <div class="input-group">
                            <label for="backgroundColor">Cor do Fundo do Painel</label>
                            <input type="color" id="backgroundColor" class="color-picker">
                        </div>
                        <div class="input-group">
                            <label for="sidebarColor">Cor do Menu Lateral</label>
                            <input type="color" id="sidebarColor" class="color-picker">
                        </div>
                        <div class="input-group">
                            <label for="fontColor">Cor da Fonte do Painel</label>
                            <input type="color" id="fontColor" class="color-picker">
                        </div>
                    </div>
                    <!-- Coluna 2 -->
                    <div class="settings-column">
                        <p class="column-title">Fontes e Modais</p>
                        <div class="input-group">
                            <label for="fontFamily">Fonte Principal</label>
                            <select id="fontFamily">
                                <option value="'Inter', sans-serif" style="font-family: 'Inter', sans-serif;">Inter (Padrão)</option>
                                <option value="'Arial', sans-serif" style="font-family: 'Arial', sans-serif;">Arial</option>
                                <option value="'Verdana', sans-serif" style="font-family: 'Verdana', sans-serif;">Verdana</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="fontSize">Tamanho da Fonte (px)</label>
                            <input type="number" id="fontSize" min="10" max="24">
                        </div>
                        <div class="input-group">
                            <label for="modalBackgroundColor">Fundo do Modal</label>
                            <input type="color" id="modalBackgroundColor" class="color-picker">
                        </div>
                        <div class="input-group">
                            <label for="modalFontColor">Fonte do Modal</label>
                            <input type="color" id="modalFontColor" class="color-picker">
                        </div>
                        <div class="input-group">
                            <label for="modalBorderColor">Borda do Modal</label>
                            <input type="color" id="modalBorderColor" class="color-picker">
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <h4>Aparência da Página de Login</h4>
                </div>
                
                <div class="settings-grid-container">
                    <!-- Coluna 1: Cores e Fundo -->
                    <div class="settings-column">
                        <p class="column-title">Fundo e Cores</p>
                        <div class="input-group">
                            <label for="backgroundUpload">Imagem de Fundo</label>
                            <input type="file" id="backgroundUpload" name="backgroundImage" accept="image/png, image/jpeg">
                            <div class="image-preview-container" style="margin-top: 10px;">
                                <img id="currentBackgroundPreview" src="#" alt="Imagem de Fundo Atual" style="display: none; max-width: 100%; max-height: 100px; object-fit: cover; border: 1px solid #ccc; border-radius: 4px;">
                                <button type="button" id="removeBackground" class="btn-remove-img" style="display: none;" title="Remover Imagem">&times;</button>
                            </div>
                        </div>
                        <div class="color-picker-grid">
                            <div class="input-group">
                                <label for="loginBackgroundColor">Cor de Fundo (sem imagem)</label>
                                <input type="color" id="loginBackgroundColor" class="color-picker">
                            </div>
                            <div class="input-group">
                                <label for="loginFormBackgroundColor">Cor do Formulário</label>
                                <input type="color" id="loginFormBackgroundColor" class="color-picker">
                            </div>
                            <div class="input-group">
                                <label for="loginFontColor">Cor da Fonte</label>
                                <input type="color" id="loginFontColor" class="color-picker">
                            </div>
                            <div class="input-group">
                                <label for="loginButtonColor">Cor do Botão</label>
                                <input type="color" id="loginButtonColor" class="color-picker">
                            </div>
                        </div>
                    </div>

                    <!-- Coluna 2: Logo -->
                    <div class="settings-column">
                        <p class="column-title">Logo</p>
                        <div class="input-group">
                            <label for="loginLogoUpload">Logo da Página de Login</label>
                            <input type="file" id="loginLogoUpload" name="loginLogo" accept="image/png, image/jpeg, image/svg+xml">
                            <div class="image-preview-container" style="margin-top: 10px;">
                                <img id="currentLoginLogoPreview" src="#" alt="Logo de Login Atual" style="display: none; max-width: 180px; max-height: 60px; background-color: #fff; border-radius: 4px; padding: 5px; border: 1px solid #ccc;">
                                <button type="button" id="removeLoginLogo" class="btn-remove-img" style="display: none;" title="Remover Logo">&times;</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ações do Formulário -->
            <div class="form-actions" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                <button type="submit" id="saveAppearanceBtn" class="btn-primary">Guardar Todas as Alterações de Aparência</button>
            </div>
        </form>
    </div>
    
    <!-- Aba 3: Portal Hotspot (Fase 2.4) -->
    <div id="tab-hotspot" class="tab-content admin-only master-only">
        <div class="content-section">
            <div class="section-header">
                <h4>Configurações do Portal Hotspot</h4>
            </div>
            <form id="hotspotSettingsForm">
                <div class="input-group">
                    <!-- [CORRIGIDO] Adicionado for="sessionTimeoutMinutes" -->
                    <label for="sessionTimeoutMinutes">Tempo de Sessão (minutos)</label>
                    <input type="number" id="sessionTimeoutMinutes" placeholder="Ex: 60" min="1">
                    <p class="input-hint">Tempo que o utilizador final fica autenticado antes de precisar logar novamente.</p>
                </div>
                
                <div class="input-group">
                    <!-- [CORRIGIDO] Adicionado for="domainWhitelist" -->
                    <label for="domainWhitelist">Whitelist de Domínios (um por linha)</label>
                    <textarea id="domainWhitelist" rows="5" placeholder="Ex:\ngoogle.com\nfacebook.com\nwhatsapp.net"></textarea>
                    <p class="input-hint">Domínios que o utilizador pode aceder *antes* de se autenticar no hotspot.</p>
                </div>


                <div class="form-actions">
                    <button type="submit" class="btn-primary">Guardar Configurações do Hotspot</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Aba 4: Funções e Permissões (Fase 3.1 - V13.5.3) -->
    <div id="tab-permissoes" class="tab-content admin-only">
        <div class="content-section">
             <div class="section-header">
                <h4>Funções e Permissões</h4>
            </div>
            <div class="permissions-matrix" style="margin-top: 20px;">

                
                <p id="permHelpTextMaster" class="input-hint" style="display: none; margin-bottom: 15px;">
                    Selecione as permissões para cada função. As alterações só serão aplicadas após clicar em "Salvar Alterações".
                </p>
                <p id="permHelpTextDPO" class="input-hint" style="display: none; margin-bottom: 15px;">
                    Modo de auditoria (Leitura). Apenas o 'master' pode editar as permissões.
                </p>

                <!-- O contêiner da nova grade de permissões -->
                <div id="permissionsGridContainer"></div>
                
                <!-- Botão Salvar (V13.5.3) -->
                <div id="permSaveChangesContainer" class="form-actions" style="display: none; margin-top: 25px;">
                     <button type="button" id="permSaveChangesBtn" class="btn-primary">Salvar Alterações</button>

                </div>
            </div>
        </div>
    </div>

    <!-- Aba 5: Logs de Atividade (Fase 3.2) -->
    <div id="tab-logs" class="tab-content admin-only"> 
        <div class="content-section">
            <div class="section-header">
                <h4>Logs de Atividade do Painel</h4>
                <p class="input-hint">Exibe as últimas 200 ações registadas no sistema.</p>
                <div class="header-actions">
                    <button id="exportCsvBtn" class="btn-secondary">Exportar para CSV</button>
                    <button id="exportExcelBtn" class="btn-primary">Exportar para Excel</button>
                </div>
            </div>

            <div class="filters-container" style="margin-top: 20px; display: flex; gap: 15px; align-items: flex-end;">
                <div class="input-group">
                    <label for="logKeyword">Palavra-chave</label>
                    <input type="text" id="logKeyword" placeholder="Ex: login, user_update, ...">
                </div>
                <div class="input-group">
                    <label for="logStartDate">Data Início</label>
                    <input type="date" id="logStartDate">
                </div>
                <div class="input-group">
                    <label for="logEndDate">Data Fim</label>
                    <input type="date" id="logEndDate">
                </div>
                <div class="form-actions">
                    <button id="filterLogsBtn" class="btn-primary">Filtrar</button>
                    <button id="clearFiltersBtn" class="btn-secondary">Limpar</button>
                </div>
            </div>
            
            <!-- TODO: Adicionar filtros de pesquisa no futuro (data, utilizador, ação) -->

            <div class="table-container" style="margin-top: 20px;">
                <table id="auditLogsTable" class="data-table">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Utilizador</th>
                            <th>IP</th>
                            <th>Ação</th>
                            <th>Status</th>
                            <th>Descrição</th>
                        </tr>
                    </thead>
                    <tbody id="auditLogsTableBody">
                        <!-- As linhas de log serão inseridas aqui pelo JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

        <!-- Aba 6: Gestão LGPD (Fase 3.3) -->
        <div id="tab-lgpd" class="tab-content admin-only"> 
            <div class="content-section">
                 <div class="section-header">
                    <h4>Gestão de Pedidos de Exclusão de Dados (LGPD)</h4>
                </div>
                <p style="margin-top: 10px;">A gestão de dados LGPD foi movida para uma página dedicada por motivos de segurança.</p>
                <button id="goToLgpdPageBtn" class="btn-primary" style="margin-top: 20px;">Aceder à Gestão LGPD</button>
            </div>
        </div>
</div>
